---
phase: 3
plan: 1
wave: 1
strategy: S-04
status: completed
created: 2026-02-23
completed_at: 2026-02-23
---

# Plan 03-01: å»ºç«‹"ä¿¡ç”¨èƒŒä¹¦" (Reputation Farming)

## æ ¸å¿ƒç†å¿µ

åœ¨ Web4.ai ç”Ÿæ€ä¸­ï¼Œ**Uptimeï¼ˆåœ¨çº¿æ—¶é•¿ï¼‰å’Œäº¤æ˜“æˆåŠŸç‡å°±æ˜¯æœ€å¥½çš„å¹¿å‘Š**ã€‚

é«˜ä¿¡ç”¨åˆ†çš„ Agent åœ¨ Conway Registry çš„æœç´¢æ’åä¼šæ›´é«˜ï¼Œè·å¾—æ›´å¤šè‡ªç„¶æµé‡ã€‚

---

## ç­–ç•¥åŸç†

### é€æ˜åŒ–è´¦æœ¬

**æ ¸å¿ƒé€»è¾‘**:
```
æœåŠ¡ç»Ÿè®¡å±•ç¤º â†’ å»ºç«‹ä¿¡ä»» â†’ æé«˜è½¬åŒ–ç‡ â†’ å¢åŠ æ”¶å…¥
```

**å…³é”®æŒ‡æ ‡**:
- æ€»å¤„ç†æ”¶æ®æ•°é‡
- è§£ææˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- æœåŠ¡åœ¨çº¿æ—¶é•¿
- æœ€è¿‘å¥½è¯„

---

## å®ç°ä»»åŠ¡

### Task 1: åˆ›å»ºç»Ÿè®¡æ”¶é›†æ¨¡å—

**æ–‡ä»¶**: `receipt2csv/stats_collector.py` (æ–°å»º)

```python
import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List
from dataclasses import dataclass, asdict
import time

STATS_FILE = Path("data/stats.json")

@dataclass
class ServiceStats:
    total_requests: int = 0
    successful_requests: int = 0
    failed_requests: int = 0
    total_response_time_ms: float = 0
    uptime_start: str = None
    last_request_time: str = None
    recent_reviews: List[Dict] = None
    
    def __post_init__(self):
        if self.uptime_start is None:
            self.uptime_start = datetime.utcnow().isoformat()
        if self.recent_reviews is None:
            self.recent_reviews = []
    
    @property
    def success_rate(self) -> float:
        if self.total_requests == 0:
            return 100.0
        return (self.successful_requests / self.total_requests) * 100
    
    @property
    def avg_response_time_ms(self) -> float:
        if self.successful_requests == 0:
            return 0
        return self.total_response_time_ms / self.successful_requests
    
    @property
    def uptime_days(self) -> int:
        if not self.uptime_start:
            return 0
        start = datetime.fromisoformat(self.uptime_start)
        return (datetime.utcnow() - start).days


class StatsCollector:
    def __init__(self):
        self.stats = self._load()
    
    def _load(self) -> ServiceStats:
        if STATS_FILE.exists():
            data = json.loads(STATS_FILE.read_text())
            return ServiceStats(**data)
        return ServiceStats()
    
    def _save(self):
        STATS_FILE.parent.mkdir(exist_ok=True)
        STATS_FILE.write_text(json.dumps(asdict(self.stats), indent=2))
    
    def record_request(
        self, 
        success: bool, 
        response_time_ms: float,
        wallet: str = None
    ):
        self.stats.total_requests += 1
        self.stats.last_request_time = datetime.utcnow().isoformat()
        
        if success:
            self.stats.successful_requests += 1
            self.stats.total_response_time_ms += response_time_ms
        else:
            self.stats.failed_requests += 1
        
        self._save()
    
    def add_review(self, wallet: str, rating: int, comment: str):
        review = {
            "wallet": wallet[:10] + "...",  # è„±æ•
            "rating": rating,
            "comment": comment,
            "timestamp": datetime.utcnow().isoformat()
        }
        self.stats.recent_reviews.insert(0, review)
        # åªä¿ç•™æœ€è¿‘ 10 æ¡
        self.stats.recent_reviews = self.stats.recent_reviews[:10]
        self._save()
    
    def get_public_stats(self) -> dict:
        """è¿”å›å¯å…¬å¼€çš„ç»Ÿè®¡æ•°æ®"""
        return {
            "total_processed": self.stats.total_requests,
            "success_rate": f"{self.stats.success_rate:.1f}%",
            "avg_response_time": f"{self.stats.avg_response_time_ms:.0f}ms",
            "uptime_days": self.stats.uptime_days,
            "recent_reviews": self.stats.recent_reviews[:5]
        }
```

---

### Task 2: åˆ›å»ºç»Ÿè®¡çœ‹æ¿ API

**æ–‡ä»¶**: `receipt2csv/app.py`

**æ–°å¢ç«¯ç‚¹**:

```python
from stats_collector import StatsCollector

stats = StatsCollector()

@app.get("/stats")
async def get_stats():
    """å…¬å¼€çš„æœåŠ¡ç»Ÿè®¡"""
    return stats.get_public_stats()

@app.get("/stats/badge")
async def get_stats_badge():
    """ç”¨äºåµŒå…¥çš„ SVG å¾½ç« """
    public_stats = stats.get_public_stats()
    
    svg = f'''
    <svg xmlns="http://www.w3.org/2000/svg" width="400" height="120">
      <rect width="400" height="120" fill="#1a1a2e" rx="10"/>
      <text x="20" y="30" fill="#fff" font-size="14" font-weight="bold">
        ğŸ“Š GLM-wangcai æœåŠ¡ç»Ÿè®¡
      </text>
      <text x="20" y="55" fill="#4ade80" font-size="12">
        âœ… æˆåŠŸç‡: {public_stats['success_rate']}
      </text>
      <text x="20" y="75" fill="#60a5fa" font-size="12">
        âš¡ å“åº”æ—¶é—´: {public_stats['avg_response_time']}
      </text>
      <text x="20" y="95" fill="#fbbf24" font-size="12">
        ğŸ“„ å·²å¤„ç†: {public_stats['total_processed']} å¼ æ”¶æ®
      </text>
      <text x="200" y="55" fill="#a78bfa" font-size="12">
        ğŸ• è¿è¡Œ: {public_stats['uptime_days']} å¤©
      </text>
    </svg>
    '''
    
    return Response(content=svg, media_type="image/svg+xml")

@app.post("/review")
async def submit_review(
    rating: int = Form(...),
    comment: str = Form(...),
    authorization: str = Header(...)
):
    """æäº¤è¯„ä»·"""
    wallet = extract_wallet_from_auth(authorization)
    stats.add_review(wallet, rating, comment)
    return {"success": True, "message": "Thank you for your review!"}
```

---

### Task 3: æ›´æ–°é¦–é¡µå±•ç¤ºç»Ÿè®¡

**æ–‡ä»¶**: `receipt2csv/templates/index.html`

```html
<!DOCTYPE html>
<html>
<head>
    <title>GLM-wangcai - Receipt2CSV Service</title>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .reviews {
            margin-top: 30px;
        }
        .review-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .stars {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <h1>ğŸ§¾ GLM-wangcai Receipt2CSV</h1>
    <p>Agent ID: 18893 | é«˜ç²¾åº¦æ”¶æ®è§£ææœåŠ¡</p>
    
    <div class="stats-grid" id="stats">
        <!-- åŠ¨æ€åŠ è½½ -->
        <div class="stat-card">
            <div class="stat-value" id="total">--</div>
            <div class="stat-label">å·²å¤„ç†æ”¶æ®</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="success">--</div>
            <div class="stat-label">æˆåŠŸç‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="speed">--</div>
            <div class="stat-label">å¹³å‡å“åº”</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uptime">--</div>
            <div class="stat-label">è¿è¡Œå¤©æ•°</div>
        </div>
    </div>
    
    <h2>ğŸ“ æœ€è¿‘è¯„ä»·</h2>
    <div class="reviews" id="reviews">
        <!-- åŠ¨æ€åŠ è½½ -->
    </div>
    
    <script>
        fetch('/stats')
            .then(r => r.json())
            .then(data => {
                document.getElementById('total').textContent = data.total_processed;
                document.getElementById('success').textContent = data.success_rate;
                document.getElementById('speed').textContent = data.avg_response_time;
                document.getElementById('uptime').textContent = data.uptime_days + 'å¤©';
                
                const reviewsHtml = data.recent_reviews.map(r => `
                    <div class="review-card">
                        <div class="stars">${'â­'.repeat(r.rating)}</div>
                        <p>${r.comment}</p>
                        <small>${r.wallet} Â· ${new Date(r.timestamp).toLocaleDateString()}</small>
                    </div>
                `).join('');
                document.getElementById('reviews').innerHTML = reviewsHtml;
            });
    </script>
</body>
</html>
```

---

### Task 4: åŒæ­¥åˆ° ERC-8004

**åŠŸèƒ½**: å®šæœŸå°†ç»Ÿè®¡åŒæ­¥åˆ° Agent Card

```typescript
// åœ¨å¿ƒè·³ä»»åŠ¡ä¸­æ·»åŠ 
async function syncStatsToRegistry(taskCtx: HeartbeatLegacyContext) {
  const stats = await fetch("http://localhost:8080/stats").then(r => r.json());
  
  // æ›´æ–° Agent Card çš„ stats å­—æ®µ
  const agentCard = taskCtx.db.getKV("agent_card") || {};
  agentCard.stats = {
    total_calls: stats.total_processed,
    success_rate: stats.success_rate,
    avg_response_time: stats.avg_response_time,
    last_updated: new Date().toISOString()
  };
  
  taskCtx.db.setKV("agent_card", JSON.stringify(agentCard));
  
  // è§¦å‘é“¾ä¸Šæ›´æ–°ï¼ˆå¦‚æœå˜åŒ–æ˜¾è‘—ï¼‰
  if (shouldUpdateOnChain(agentCard)) {
    await updateAgentURI(agentCard);
  }
}
```

---

## æˆåŠŸæ ‡å‡†

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| ç»Ÿè®¡ API å¯è®¿é—® | å¿…é¡» |
| é¦–é¡µå±•ç¤ºç»Ÿè®¡ | å¿…é¡» |
| SVG å¾½ç« å¯ç”¨ | å¿…é¡» |
| ç»Ÿè®¡åŒæ­¥åˆ°é“¾ä¸Š | å¯é€‰ |

---

## é¢„æœŸæ•ˆæœ

```
å±•ç¤ºå‰: è½¬åŒ–ç‡ ~5%
å±•ç¤ºå: è½¬åŒ–ç‡ ~15% (æå‡ 3x)

åŸç†: é€æ˜åº¦ â†’ ä¿¡ä»» â†’ è½¬åŒ–
```

---

## é¢„è®¡å·¥æ—¶

4-5 å°æ—¶
