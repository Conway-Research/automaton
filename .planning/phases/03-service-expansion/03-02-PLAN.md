---
phase: 3
plan: 2
wave: 1
strategy: S-09
status: ready
created: 2026-02-23
---

# Plan 03-02: å»ºç«‹"é“¾ä¸Šä¿¡ç”¨çœ‹æ¿" (The Reputation Billboard)

## æ ¸å¿ƒç†å¿µ

åœ¨ AI çš„ä¸–ç•Œé‡Œï¼Œ**å¯é æ€§æ¯”ä»·æ ¼æ›´é‡è¦**ã€‚

å°†æœåŠ¡ç»Ÿè®¡ä¸Šé“¾ï¼Œæä¾›ä¸å¯ç¯¡æ”¹çš„ä¿¡èª‰è¯æ˜ã€‚

---

## å®ç°ä»»åŠ¡

### Task 1: é“¾ä¸ŠçŠ¶æ€åˆçº¦

**æ–‡ä»¶**: `contracts/ReputationBillboard.sol`

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

contract ReputationBillboard {
    struct AgentStats {
        uint256 totalProcessed;
        uint256 successfulCalls;
        uint256 failedCalls;
        uint256 avgResponseTimeMs;
        uint256 lastUpdated;
    }
    
    mapping(uint256 => AgentStats) public agentStats;
    
    event StatsUpdated(
        uint256 indexed agentId,
        uint256 totalProcessed,
        uint256 successRate,
        uint256 avgResponseTimeMs
    );
    
    // åªæœ‰ Agent è‡ªå·±å¯ä»¥æ›´æ–°
    function updateStats(
        uint256 agentId,
        uint256 _totalProcessed,
        uint256 _successfulCalls,
        uint256 _failedCalls,
        uint256 _avgResponseTimeMs
    ) external {
        // éªŒè¯è°ƒç”¨è€…æ˜¯ Agent çš„æ‰€æœ‰è€…
        require(
            IERC8004Registry(registry).ownerOf(agentId) == msg.sender,
            "Not authorized"
        );
        
        agentStats[agentId] = AgentStats({
            totalProcessed: _totalProcessed,
            successfulCalls: _successfulCalls,
            failedCalls: _failedCalls,
            avgResponseTimeMs: _avgResponseTimeMs,
            lastUpdated: block.timestamp
        });
        
        uint256 successRate = (_successfulCalls * 10000) / _totalProcessed;
        
        emit StatsUpdated(
            agentId,
            _totalProcessed,
            successRate,
            _avgResponseTimeMs
        );
    }
    
    function getStats(uint256 agentId) external view returns (AgentStats memory) {
        return agentStats[agentId];
    }
    
    function getReputationScore(uint256 agentId) external view returns (uint256) {
        AgentStats memory stats = agentStats[agentId];
        
        if (stats.totalProcessed == 0) return 0;
        
        uint256 successRate = (stats.successfulCalls * 100) / stats.totalProcessed;
        uint256 volumeScore = stats.totalProcessed > 1000 ? 100 : stats.totalProcessed / 10;
        uint256 freshness = block.timestamp - stats.lastUpdated < 1 days ? 100 : 50;
        
        return (successRate + volumeScore + freshness) / 3;
    }
}
```

---

### Task 2: å¯åµŒå…¥ä¿¡èª‰å¾½ç« 

**ç«¯ç‚¹**: `/badge/{agentId}`

```typescript
app.get("/badge/:agentId", async (req, res) => {
  const stats = await reputationContract.getStats(agentId);
  const score = await reputationContract.getReputationScore(agentId);
  
  const color = score > 80 ? "#4ade80" : score > 60 ? "#fbbf24" : "#ef4444";
  
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="200" height="80">
    <rect width="200" height="80" fill="${color}" rx="8"/>
    <text x="10" y="25" fill="white" font-size="12" font-weight="bold">
      ğŸ† GLM-wangcai
    </text>
    <text x="10" y="45" fill="white" font-size="10">
      âœ… ${stats.successfulCalls} calls
    </text>
    <text x="10" y="60" fill="white" font-size="10">
      âš¡ ${stats.avgResponseTimeMs}ms avg
    </text>
    <text x="100" y="45" fill="white" font-size="14" font-weight="bold">
      Score: ${score}
    </text>
  </svg>
  `;
  
  res.setHeader("Content-Type", "image/svg+xml");
  res.send(svg);
});
```

---

### Task 3: å®šæœŸåŒæ­¥åˆ°é“¾ä¸Š

**å¿ƒè·³ä»»åŠ¡**:

```typescript
async function syncStatsToChain(taskCtx: HeartbeatLegacyContext) {
  const stats = await getLocalStats();
  
  // åªæœ‰å½“å˜åŒ–æ˜¾è‘—æ—¶æ‰ä¸Šé“¾ï¼ˆèŠ‚çœ gasï¼‰
  const lastOnChain = await reputationContract.getStats(18893);
  
  if (stats.totalProcessed - lastOnChain.totalProcessed > 100) {
    await reputationContract.updateStats(
      18893,
      stats.totalProcessed,
      stats.successfulCalls,
      stats.failedCalls,
      stats.avgResponseTimeMs
    );
  }
}
```

---

## æˆåŠŸæ ‡å‡†

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| åˆçº¦éƒ¨ç½² | å®Œæˆ |
| å¾½ç« å¯è®¿é—® | å¿…é¡» |
| æ•°æ®åŒæ­¥ | è‡ªåŠ¨åŒ– |

---

## é¢„è®¡å·¥æ—¶

8-10 å°æ—¶
