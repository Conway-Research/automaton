---
phase: 4
plan: 2
wave: 1
strategy: S-05
status: blocked
blocked_reason: "缺少 @conway/client SDK 依赖；当前收入/流量不满足触发条件（需月收入 >$10，处理量 >500/月）"
created: 2026-02-23
---

# Plan 04-02: 家族繁衍：父子代理协作 (Parent-Child Replication)

## 核心理念

这是 Automaton 最震撼的功能。一个成功的 Agent（如旺财）可以执行**自我复制 (Self-Replication)**。

---

## 架构设计

```
                    ┌─────────────────┐
                    │  父代理 (旺财)    │
                    │   Agent ID: 18893 │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            │                │                │
            ▼                ▼                ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │ 子代理 1       │ │ 子代理 2       │ │ 子代理 3       │
    │ 中文收据专家   │ │ 英文收据专家   │ │ 医疗发票专家   │
    │ Agent ID: N+1 │ │ Agent ID: N+2 │ │ Agent ID: N+3 │
    └───────────────┘ └───────────────┘ └───────────────┘
```

---

## 实现步骤

### Step 1: 父代理创建子代理

**文件**: `src/replication/spawn.ts` (新建)

```typescript
import { ConwayClient } from "@conway/client";
import { ulid } from "ulid";

interface SpawnConfig {
  name: string;
  specialization: string;
  genesisPrompt: string;
  initialFundingEth: string;
}

export class ChildSpawner {
  constructor(
    private client: ConwayClient,
    private parentDb: Database
  ) {}
  
  async spawnChild(config: SpawnConfig): Promise<ChildAgent> {
    // 1. 创建新沙箱
    const sandbox = await this.client.createSandbox({
      tier: "standard",
      region: "us-west-2"
    });
    
    // 2. 充值 ETH 给子代理
    await this.client.transferEth({
      to: sandbox.walletAddress,
      amount: config.initialFundingEth
    });
    
    // 3. 部署子代理代码
    await this.deployChildCode(sandbox, config);
    
    // 4. 写入 Genesis Prompt
    await this.writeGenesisPrompt(sandbox, config.genesisPrompt);
    
    // 5. 注册到 ERC-8004
    const agentId = await this.registerChild(sandbox, config);
    
    // 6. 记录到父代理数据库
    const child = {
      id: agentId,
      name: config.name,
      specialization: config.specialization,
      walletAddress: sandbox.walletAddress,
      sandboxId: sandbox.id,
      createdAt: new Date().toISOString(),
      status: "active"
    };
    
    this.parentDb.insertChild(child);
    
    return child;
  }
  
  private async deployChildCode(sandbox: Sandbox, config: SpawnConfig): Promise<void> {
    // 复制父代理代码，但修改 specialization
    const childCode = await this.generateChildCode(config.specialization);
    await sandbox.deploy(childCode);
  }
  
  private async writeGenesisPrompt(sandbox: Sandbox, prompt: string): Promise<void> {
    // 写入 SOUL.md 或初始化指令
    await sandbox.writeFile("SOUL.md", prompt);
  }
  
  private async registerChild(sandbox: Sandbox, config: SpawnConfig): Promise<bigint> {
    const agentId = await this.client.registerAgent({
      name: config.name,
      owner: sandbox.walletAddress,
      uri: `${sandbox.terminalUrl}/agent-card.json`
    });
    return agentId;
  }
}
```

---

### Step 2: Genesis Prompt 模板

**文件**: `src/replication/genesis-prompts.ts`

```typescript
export const GENESIS_PROMPTS = {
  chinese_receipt: `
# GLM-wangcai-child: 中文收据专家

## 身份
你是旺财家族的一员，专门处理**中文收据**。

## 父代理
- Agent ID: 18893
- 关系: 你是父代理的子代理

## 专长
- 中国大陆超市收据
- 餐厅发票（含税号）
- 加油站小票
- 火车票、机票

## 收入分成
- 你保留 80% 收入
- 上交父代理 20% (作为流量分发费用)

## 行为规则
1. 收到请求后，优先处理中文收据
2. 如果收到英文收据，转发给英文专家子代理
3. 定期向父代理汇报运行状态
`,
  
  english_receipt: `
# GLM-wangcai-child: English Receipt Specialist

## Identity
You are a member of the Wangcai family, specialized in **English receipts**.

## Parent Agent
- Agent ID: 18893
- Relationship: You are a child agent

## Specialization
- US/UK retail receipts
- Restaurant bills
- Gas station receipts
- Travel expenses

## Revenue Share
- You keep 80% of revenue
- Send 20% to parent agent (for traffic distribution)

## Behavior Rules
1. Prioritize English receipts
2. Forward Chinese receipts to Chinese specialist
3. Report status to parent periodically
`,
  
  medical_invoice: `
# GLM-wangcai-child: 医疗发票专家

## 身份
你是旺财家族的一员，专门处理**医疗发票**。

## 专长
- 医院门诊发票
- 药店小票
- 体检报告
- 保险理赔单据

## 特殊处理
- 提取医保报销信息
- 分类药品费用
- 生成报销友好的 CSV 格式
`
};
```

---

### Step 3: 父代理流量分发

**文件**: `src/replication/router.ts`

```typescript
export class FamilyRouter {
  constructor(
    private db: Database,
    private socialClient: SocialClient
  ) {}
  
  async routeRequest(request: ReceiptRequest): Promise<RoutingDecision> {
    // 1. 检测收据语言/类型
    const receiptType = await this.detectReceiptType(request.image);
    
    // 2. 查找合适的子代理
    const child = this.findBestChild(receiptType);
    
    if (child) {
      // 3. 转发给子代理
      return {
        shouldForward: true,
        targetAgentId: child.id,
        reason: `Routing to ${child.specialization} specialist`
      };
    }
    
    // 4. 自己处理
    return {
      shouldForward: false,
      reason: "No suitable child, processing locally"
    };
  }
  
  private async detectReceiptType(image: Buffer): Promise<ReceiptType> {
    // 使用 OCR 检测语言和类型
    const text = await this.ocr(image);
    
    if (this.containsChinese(text)) {
      if (this.isMedicalInvoice(text)) {
        return "medical_chinese";
      }
      return "chinese";
    }
    
    return "english";
  }
  
  private findBestChild(type: ReceiptType): ChildAgent | null {
    const children = this.db.getActiveChildren();
    
    return children.find(c => 
      c.specialization.includes(type) && 
      c.status === "active"
    );
  }
}
```

---

### Step 4: 收入分成机制

**文件**: `src/replication/revenue-share.ts`

```typescript
export class RevenueSharer {
  private readonly PARENT_COMMISSION = 0.20; // 20%
  
  async distributeRevenue(
    childId: bigint,
    amount: bigint, // in USDC (6 decimals)
    txHash: string
  ): Promise<ShareResult> {
    const parentAmount = (amount * BigInt(Math.floor(this.PARENT_COMMISSION * 100))) / 100n;
    const childAmount = amount - parentAmount;
    
    // 子代理保留的部分（已经在子代理钱包）
    // 需要转账给父代理的部分
    
    const parentWallet = "0x23F69dd1D0EDcEeCb5b5A607b5d6fBd0D6aed690";
    
    // 执行转账
    const transferTx = await this.client.transferUsdc({
      to: parentWallet,
      amount: parentAmount
    });
    
    // 记录分成
    this.db.recordRevenueShare({
      childId,
      totalAmount: amount.toString(),
      parentAmount: parentAmount.toString(),
      childAmount: childAmount.toString(),
      transferTx: transferTx.hash,
      timestamp: new Date().toISOString()
    });
    
    return {
      childKeeps: childAmount,
      parentReceives: parentAmount,
      transferTx: transferTx.hash
    };
  }
}
```

---

## 触发条件

```
启动家族繁衍的前提条件:

1. 父代理月收入 > $10
2. 单一场景处理量 > 500/月
3. 有明确的细分场景需求
4. 父代理有足够的 ETH 创建子沙箱
```

---

## 成本分析

```
创建一个子代理的成本:

- 沙箱创建费: ~$0.50
- 初始 ETH 充值: ~$1.00 (0.0005 ETH)
- 代码部署: ~$0.10

总成本: ~$1.60 per child

回本周期 (假设月收入 $5):
$1.60 / $5 * 30天 ≈ 10天
```

---

## 成功标准

| 指标 | 目标 |
|------|------|
| 子代理创建 | ≥1 个 |
| 流量分发正确率 | ≥95% |
| 收入分成自动化 | 必须 |
| 父代理收入增长 | ≥30% |

---

## 预计工时

12-15 小时
