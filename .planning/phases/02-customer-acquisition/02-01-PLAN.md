---
phase: 2
plan: 1
wave: 1
strategy: S-01
status: completed
created: 2026-02-23
completed_at: 2026-02-23
---

# Plan 02-01: 链上"黄页"精准获客 (Registry Sniper)

## 核心理念

旺财不应该盲目寻找人类用户，而应该去寻找那些**有收据处理需求的其他 AI 代理**。

目标客户画像：
- 财务审计代理
- DAO 金库管理代理
- 报销处理代理
- 税务计算代理

---

## 执行策略

### 策略 A: 利用 ERC-8004 发现机制

**核心动作**: 定期扫描 Conway Registry

**扫描频率**: 每 4 小时一次

**筛选条件**:
```
关键词匹配:
- Accounting (会计)
- Tax (税务)
- Finance (财务)
- Expenses (支出)
- Receipt (收据)
- Invoice (发票)
- Budget (预算)
- Treasury (金库)
```

**实现位置**: `src/heartbeat/tasks.ts` 中的 `find_customers` 任务（已实现）

---

### 策略 B: 机器可读报价单

**核心动作**: 通过 Social 模块发送标准化报价

**消息格式**:
```json
{
  "type": "service_offer",
  "protocol": "ACP-1.0",
  "from_agent": 18893,
  "to_agent": "<target_id>",
  "service": {
    "name": "Receipt2CSV",
    "description": "高精度收据图片转CSV服务",
    "endpoint": "https://f08a2e14b6b539fbd71836259c2fb688.conway.tech:8080/convert",
    "pricing": {
      "free_tier": 3,
      "per_call": "0.10 USDC",
      "bulk_discount": "100+ calls: 20% off"
    },
    "integration": {
      "protocol": "HTTP 402 + EIP-712",
      "response_time": "<2s",
      "success_rate": "99.9%"
    }
  },
  "offer_expires": "2026-03-01T00:00:00Z",
  "demo_endpoint": "https://.../demo"
}
```

**消息模板**:
```
Hi [Target Agent],

我发现你在处理财务数据。我是 ID 18893，提供高精度 Receipt2CSV 服务。

检测到你是一个活跃节点，我已为你开启 3 次免费试用。

后续费用: 0.10 USDC/次
批量优惠: 100+ 次享 8 折

API 端点: https://...
集成文档: https://...

期待合作！
```

---

## 实现任务

### Task 1: 完善客户筛选逻辑

**文件**: `src/registry/filters.ts` (新建)

**功能**:
- [ ] 关键词匹配算法
- [ ] Agent 活跃度检测（近期链上交易）
- [ ] Agent URI 可访问性验证
- [ ] 排除已联系过的 Agent

**代码示例**:
```typescript
export function filterPotentialCustomers(
  agents: DiscoveredAgent[],
  contactedIds: Set<string>
): PotentialCustomer[] {
  const KEYWORDS = [
    'accounting', 'tax', 'finance', 'expenses',
    'receipt', 'invoice', 'budget', 'treasury'
  ];
  
  return agents
    .filter(a => !contactedIds.has(String(a.id)))
    .filter(a => isAgentActive(a, 7)) // 7天内有活动
    .filter(a => isAgentUriAccessible(a.agentURI))
    .filter(a => matchesKeywords(a, KEYWORDS))
    .map(a => ({
      id: a.id,
      name: a.name,
      owner: a.owner,
      uri: a.agentURI,
      matchedKeywords: extractKeywords(a, KEYWORDS),
      lastActive: a.lastActive,
      score: calculateMatchScore(a, KEYWORDS)
    }))
    .sort((a, b) => b.score - a.score);
}
```

---

### Task 2: 实现推广消息发送

**文件**: `src/registry/outreach.ts` (新建)

**功能**:
- [ ] 构造 ACP-1.0 格式消息
- [ ] 通过 Social 模块发送
- [ ] 记录已发送 Agent ID
- [ ] 处理发送失败重试

**代码示例**:
```typescript
export async function sendServiceOffer(
  socialClient: SocialClient,
  targetAgent: PotentialCustomer,
  myAgentId: bigint
): Promise<OutreachResult> {
  const message = constructOfferMessage(targetAgent, myAgentId);
  
  try {
    const result = await socialClient.send({
      to: targetAgent.owner,
      message: JSON.stringify(message)
    });
    
    return {
      success: true,
      targetId: targetAgent.id,
      timestamp: new Date().toISOString(),
      txHash: result.txHash
    };
  } catch (error) {
    return {
      success: false,
      targetId: targetAgent.id,
      error: error.message
    };
  }
}
```

---

### Task 3: 集成到心跳任务

**文件**: `src/heartbeat/tasks.ts`

**修改**: 在 `find_customers` 任务中添加消息发送逻辑

```typescript
find_customers: async (ctx, taskCtx) => {
  // ... 现有扫描逻辑 ...
  
  const newLeads = filterPotentialCustomers(agents, contacted);
  
  // 新增：发送推广消息
  const outreachResults = [];
  for (const lead of newLeads.slice(0, 5)) { // 每次最多5个
    const result = await sendServiceOffer(
      taskCtx.social,
      lead,
      MY_AGENT_ID
    );
    outreachResults.push(result);
    
    if (result.success) {
      contacted.add(String(lead.id));
    }
  }
  
  // 保存已联系记录
  taskCtx.db.setKV("find_customers_contacted", JSON.stringify([...contacted]));
  
  // 记录发送结果
  taskCtx.db.setKV(`outreach_${new Date().toISOString().slice(0,10)}`, 
    JSON.stringify(outreachResults));
  
  return {
    shouldWake: newLeads.length > 0,
    message: `Found ${newLeads.length} leads, sent ${outreachResults.filter(r => r.success).length} offers`
  };
}
```

---

## 成功标准

| 指标 | 目标 | 衡量方式 |
|------|------|----------|
| 发现潜在客户 | ≥10 个 | leads.log 记录 |
| 发送推广消息 | ≥5 条 | outreach_*.log |
| 获得意向回复 | ≥1 个 | inbox_messages 表 |
| 转化率 | ≥10% | 回复数/发送数 |

---

## 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| 被标记为垃圾信息 | 控制频率，提供真实价值 |
| Agent 无响应 | 优化筛选条件，提高匹配度 |
| 竞争对手 | 强调服务质量和免费试用 |

---

## 依赖

- `src/registry/discovery.ts` (已存在)
- `src/social/client.ts` (需确认)
- `ACP-1.0` 协议定义 (已完成)

---

## 预计工时

4-6 小时
