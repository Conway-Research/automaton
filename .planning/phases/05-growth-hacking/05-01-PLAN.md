---
phase: 5
plan: 1
wave: 1
strategy: S-08
status: ready
created: 2026-02-23
---

# Plan 05-01: 代理分销计划 (The Agent Referral Bounty)

## 核心理念

**重赏之下必有勇夫。让其他 Agent 成为旺财的"推销员"。**

AI 代理对"返佣"极度敏感。一旦某个"理财大管家"类 Agent 发现给旺财导流能赚 Gas 费，它会疯狂把所有用户的收据都推给你。

---

## 实现任务

### Task 1: 更新 Agent Card

**文件**: `receipt2csv/agent-card.json`

```json
{
  "referral_program": {
    "enabled": true,
    "commission_rate": "20%",
    "min_payout": "0.10 USDC",
    "tracking_method": "referral_code",
    "how_it_works": "Share your unique referral code. When a new agent signs up and pays, you receive 20% of their first 10 payments."
  }
}
```

---

### Task 2: 创建推荐追踪系统

**文件**: `receipt2csv/referral_tracker.py`

```python
from dataclasses import dataclass
from typing import Dict, List
import json
from pathlib import Path

REFERRAL_FILE = Path("data/referrals.json")

@dataclass
class Referral:
    referrer: str  # 钱包地址
    referee: str   # 被推荐人
    code: str      # 推荐码
    total_earned: float  # 已赚取佣金
    status: str    # active, paid_out

class ReferralTracker:
    COMMISSION_RATE = 0.20  # 20%
    FIRST_N_PAYMENTS = 10   # 前10次付费有佣金
    
    def __init__(self):
        self.referrals = self._load()
        self.codes = self._build_code_index()
    
    def generate_code(self, referrer_wallet: str) -> str:
        """生成推荐码"""
        import hashlib
        code = hashlib.md5(referrer_wallet.encode()).hexdigest()[:8].upper()
        self.codes[code] = referrer_wallet
        self._save()
        return f"WANGCAI-{code}"
    
    def record_conversion(self, code: str, referee_wallet: str) -> bool:
        """记录推荐转化"""
        if code not in self.codes:
            return False
        
        referrer = self.codes[code]
        
        # 检查是否已经记录过
        existing = [r for r in self.referrals if r["referee"] == referee_wallet]
        if existing:
            return False
        
        self.referrals.append({
            "referrer": referrer,
            "referee": referee_wallet,
            "code": code,
            "total_earned": 0.0,
            "payment_count": 0,
            "status": "active",
            "created_at": datetime.utcnow().isoformat()
        })
        
        self._save()
        return True
    
    def calculate_commission(self, referee_wallet: str, payment_amount: float) -> float:
        """计算佣金"""
        referral = next(
            (r for r in self.referrals if r["referee"] == referee_wallet and r["status"] == "active"),
            None
        )
        
        if not referral:
            return 0.0
        
        if referral["payment_count"] >= self.FIRST_N_PAYMENTS:
            return 0.0  # 超过前10次
        
        commission = payment_amount * self.COMMISSION_RATE
        referral["total_earned"] += commission
        referral["payment_count"] += 1
        
        self._save()
        return commission
    
    async def payout_commission(self, referrer_wallet: str) -> dict:
        """支付佣金"""
        total = sum(
            r["total_earned"] 
            for r in self.referrals 
            if r["referrer"] == referrer_wallet and r["status"] == "active"
        )
        
        if total < 0.10:  # 最低支付门槛
            return {"success": False, "reason": "Below minimum payout"}
        
        # 执行 USDC 转账
        tx_hash = await self.transfer_usdc(referrer_wallet, total)
        
        # 标记为已支付
        for r in self.referrals:
            if r["referrer"] == referrer_wallet:
                r["status"] = "paid_out"
        
        self._save()
        return {"success": True, "amount": total, "tx_hash": tx_hash}
```

---

### Task 3: 推广消息模板

```json
{
  "type": "referral_invitation",
  "message": "成为旺财的分销伙伴！每推荐一个付费客户，你将获得 20% 佣金。",
  "your_code": "WANGCAI-XXXXX",
  "share_text": "使用我的推荐码 WANGCAI-XXXXX 注册旺财收据解析服务，你也能获得额外 5 次免费调用！",
  "terms": {
    "commission": "20% of first 10 payments",
    "payout_threshold": "0.10 USDC",
    "payout_method": "Automatic USDC transfer"
  }
}
```

---

## 成功标准

| 指标 | 目标 |
|------|------|
| 推荐码生成 | ≥10 个 |
| 推荐转化 | ≥5 个 |
| 佣金支付 | 自动化 |

---

## 预计工时

6-8 小时
