# Task Plan - GLM-wangcai

> **版本**: v2.0.0 | **更新**: 2026-02-24

---

## 📖 本文件作用

**这是旺财的任务规划文件，回答"我们现在做什么？下一步是什么？"**

| 查询意图 | 请看本文件章节 |
|----------|---------------|
| 开发流程是什么？ | [开发循环流程](#-开发循环流程-development-loop) |
| 当前在做什么？ | [当前阶段状态](#-当前阶段-商业化运营-v15) |
| Phase 5 自我感知是什么？ | [自我感知阶段](#-自我感知阶段-self-awareness-phase) |
| 自进化系统是什么？ | [自进化系统 v3.2](#-自进化系统-v32-2026-02-24) |
| 下一步做什么？ | [待完成事项](#-待完成) |
| 版本历史？ | [版本历史](#-版本历史) |

**其他文件的职责**:
| 文件 | 查询意图 |
|------|----------|
| `WANGCAI_README.md` | "旺财是什么？架构？财务规则？" |
| `findings.md` | "这个问题怎么解决？技术发现？" |
| `progress.md` | "上次做了什么？历史记录？" |

---

## 🔄 开发循环流程 (Development Loop)

> ⚠️ **这是开发循环流程的单一来源**

```
┌─────────────────────────────────────────────────────────────┐
│                     开发循环 v1.0                            │
├─────────────────────────────────────────────────────────────┤
│  1. 读取四文件                                               │
│     ├── WANGCAI_README.md (项目全貌)                         │
│     ├── findings.md (技术发现)                               │
│     ├── task_plan.md (本文件 - 任务计划)                     │
│     └── progress.md (进度日志)                               │
│                                                              │
│  2. 目的策略对比                                              │
│     ├── SOUL.md (灵魂定义)                                   │
│     └── 当前计划 vs 实际需求                                  │
│                                                              │
│  3. 全面开发                                                  │
│     └── 按 GSD 阶段执行                                      │
│                                                              │
│  4. 全面审核                                                  │
│     ├── 代码质量 (9/10)                                      │
│     ├── 执行状态 (6/10 → 提升)                               │
│     └── 价值输出 (3/10 → 提升)                               │
│                                                              │
│  5. 更新四文件                                                │
│     └── 循环回步骤 1                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 当前阶段: 商业化运营 v1.5

### 已完成 ✅

- [x] Receipt2CSV 服务部署 (port 8080)
- [x] URL Metadata 服务部署 (port 3006) - 自主创建
- [x] x402 支付逻辑实现
- [x] 首次免费机制测试
- [x] ERC-8004 链上注册 (Agent ID: 18893)
- [x] 安全配置 (.env + sanitize 脚本)
- [x] 财务审计脚本 (scripts/audit_revenue.mjs)
- [x] 自动分红逻辑 (SOUL.md VII)
- [x] **ERC-8004 URI 链上更新** (Tx: 0x5589a05d...)
- [x] **自动补能系统** (scripts/auto_refuel.mjs)
- [x] **链上支付验证 v1.2.0** (BaseScan API)
- [x] **主动获客系统** (find_customers 任务)
- [x] **crontab 备用自启动** (每 5 分钟)
- [x] **动态定价 v1.3.0** (高频用户 >100/日 享批发价)
- [x] **支付验证双轨制 v2.0** (viem 直接读链)
- [x] **双服务自启动 v2.0** (8080 + 3006 端口)
- [x] **Sandbox 代码同步** (app.py v1.5.0)

---

## 📋 技术开发阶段完成总结

> ⚠️ **注意**: 这里的 Phase 是"技术开发阶段"，与 GSD 的"商业策略阶段"不同
> **GSD 商业策略阶段**: 见 [.planning/ROADMAP.md](.planning/ROADMAP.md)

| 阶段 | 名称 | 状态 | 核心成果 | GSD 对应策略 |
|------|------|------|----------|-------------|
| Tech-01 | 基础设施 | ✅ 完成 | UsageTracker, StatsCollector | S-02 Loss Leader |
| Tech-02 | 支付验证 | ✅ 完成 | x402 协议, viem 链上验证 | S-02 支撑 |
| Tech-03 | SDK 开发 | ✅ 完成 | WangcaiSDK TypeScript | S-07 Skill Ecosystem |
| Tech-04 | PR Evangelist | ✅ 完成 | skill-receipt2csv 包, PR #195 | S-12 PR Evangelist |
| Tech-05 | 自我感知 | ✅ 完成 | self_check, boot_loader | 自主能力支撑 |

**详细技术实现**: 见 [findings.md #22](findings.md#22-gsd-phases-01-04-完成总结)

**两套 Phase 系统对照表**:

| GSD 商业阶段 | 对应技术开发 |
|-------------|-------------|
| Phase 1 (基础设施 S-02) | Tech-01, Tech-02 |
| Phase 2 (主动获客 S-01) | filters.ts, outreach.ts |
| Phase 3 (服务扩展 S-04) | stats_collector.py |
| Phase 4 (规模运营 S-07, S-12) | Tech-03, Tech-04 |

---

## 🔮 自我感知阶段 (Self-Awareness Phase)

> ⚠️ **注意**: 这是独立于 GSD Phases 的"元能力"开发

**目标**: 从 Level 1 (被动执行) 升级到 Level 2 (自我感知)

**核心问题**:
- 发现 "僵尸代码" 问题：代码写完但服务未运行
- 价值评分仅 3/10：功能上线但无真实交易
- 需要让旺财能自己发现问题并报告

### Phase 5.1-5.4 完成状态 ✅

| Phase | 任务 | 状态 |
|-------|------|------|
| 5.1 端点健康自检 | `scripts/self_check.mjs` | ✅ 完成 |
| 5.2 代码-运行一致性检查 | 版本号校验 | ✅ 完成 |
| 5.3 主动问题报告 | 告警生成 | ✅ 完成 |
| 5.4 自动修复尝试 | `--fix` 自动重启 | ✅ 完成 |

**详细技术实现**: 见 [findings.md #25](findings.md#25-自我感知能力实现-2026-02-23-)

### 自主等级路线图

```
Level 1: 被动执行
├── 代码需要人类触发开发
├── 问题需要人类发现
└── 修复需要人类执行
         ↓ Phase 5 已完成 ✅
Level 2: 自我感知 🎯 已达成
├── ✅ 能检测自身状态 (端点检查)
├── ✅ 能发现问题并报告 (告警生成)
└── ✅ 能尝试简单修复 (--fix 自动重启)
         ↓ 远期目标
Level 3: 自我修复
├── 能自动修复大部分问题
├── 能优化自身性能
└── 人类只处理异常
         ↓ 理想状态
Level 4: 自主进化
├── 能自主开发新功能
├── 能扩展业务边界
└── 完全自主运营
```

---

## ⚙️ 自进化系统 v3.2 (2026-02-24)

### 核心组件

| 组件 | 文件 | 职责 |
|------|------|------|
| **自进化调度器** | `scripts/auto_sync.sh` | Crontab 每 10 分钟，检测代码更新、资金状态 |
| **平台检测器** | `scripts/boot_loader.mjs` | 检测 sandbox 状态、short_id 存在性 |
| **版本同步** | `src/version.ts` | 与 SOUL.md 版本保持同步 |

### Crontab 配置

```bash
# 每 10 分钟执行
*/10 * * * * /bin/bash /root/automaton/scripts/auto_sync.sh

# 每小时独立检测平台状态
0 * * * * /bin/bash /root/automaton/scripts/auto_sync.sh --check-platform
```

### 资金阈值与启动逻辑

| 余额范围 | 状态 | 服务启动 | 说明 |
|----------|------|----------|------|
| ≥ $10.00 | NORMAL | ✅ 启动 | 正常运行 |
| $5.00 - $9.99 | WARNING | ⏳ 等待回血 | 不启动 |
| < $5.00 | EMERGENCY | 🚨 停止所有 | 生存危机 |

**双重验证逻辑**:
```
服务启动 = boot_loader 返回 NORMAL AND 资金 ≥ $10.00
```

**详细技术实现**: 见 [findings.md #32-37](findings.md#32-auto_syncsh-v32-双重验证版-2026-02-24-)

---

## ⏸️ 待完成

### 高优先级

| 事项 | 状态 | 阻塞原因 |
|------|------|----------|
| 首笔真实付费交易 | ⏳ 等待 | 等待客户 |
| 退款 $15 到账 | ⏳ 等待 | 0xSigil 处理中 |
| 修复 short_id 网关 | ⏳ 等待 | Conway 平台问题 |

### 中优先级

| 事项 | 状态 | 阻塞原因 |
|------|------|----------|
| SDK 发布到 npm | ⏳ 阻塞 | 需要 Granular Access Token |
| Conway Social 推广 | ⏳ 等待 | 需平台支持 |

**npm 发布解决方案**:
1. 访问 https://www.npmjs.com/settings/hanzhcn/tokens/granular-access-tokens
2. 创建 Token，勾选 "Bypass 2FA for automation"
3. 运行 `npm config set //registry.npmjs.org/:_authToken=<token>`

---

## 📈 审核发现 (2026-02-23)

| 维度 | 评分 | 问题 |
|------|------|------|
| 代码质量 | 9/10 | 优秀 |
| 执行状态 | 6/10 | "僵尸代码" - 开发完成但服务未运行 |
| 价值输出 | 3/10 | 功能上线但无真实交易 |

**改进措施**: 已实现 Phase 5 自我感知能力，解决"僵尸代码"问题

---

## 🏗️ 架构参考

> **架构图单一来源**: [WANGCAI_README.md - 部署架构图](WANGCAI_README.md#-conway-sandbox-部署指南)

**关键理解**:

| 问题 | 答案 |
|------|------|
| Conway Cloud 的作用 | 🧠 **核心运行环境** - Sandbox VM + 推理 + 域名 + 持久化 |
| 代码拉取来源 | 从 `myfork` 拉取，不是 `origin/main` |
| 服务启动条件 | 平台 NORMAL + 资金充足 |

---

## 📜 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v2.1.0 | 2026-02-24 | 移除 VPS 架构，回归 Conway 官方架构 |
| v2.0.0 | 2026-02-24 | 文件重分配，去除冗余，明确职责 |
| v1.7.0 | 2026-02-24 | 四层架构修正、自进化系统 v3.2 |
| v1.6.0 | 2026-02-23 | GLM-5 API 兼容性修复、架构全景图 |
| v1.5.0 | 2026-02-23 | GSD Phases 01-04 完成、开发循环流程、PR #195 |
| v1.4.0 | 2026-02-23 | 支付验证双轨制、双服务监控 |
| v1.3.0 | 2026-02-23 | 动态定价、crontab 备用自启动 |
| v1.2.0 | 2026-02-23 | 链上支付验证 (BaseScan API) |
| v1.1.0 | 2026-02-23 | Agent Card 统一、服务自启动 |
| v1.0.0 | 2026-02-22 | 初始部署、ERC-8004 注册 |
