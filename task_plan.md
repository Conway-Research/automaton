# Task Plan - GLM-wangcai

> 更新时间: 2026-02-23 (Session 8 - 架构深度研究)

## 开发循环流程 (Development Loop)

```
┌─────────────────────────────────────────────────────────────┐
│                     开发循环 v1.0                            │
├─────────────────────────────────────────────────────────────┤
│  1. 读取四文件                                               │
│     ├── findings.md (技术发现)                               │
│     ├── task_plan.md (任务计划)                              │
│     ├── progress.md (进度日志)                               │
│     └── WANGCAI_README.md (项目文档)                         │
│                                                              │
│  2. 目的策略对比                                              │
│     ├── SOUL.md (灵魂定义)                                   │
│     └── 当前计划 vs 实际需求                                  │
│                                                              │
│  3. 全面开发                                                  │
│     └── 按 GSD 阶段执行                                      │
│                                                              │
│  4. 全面审核                                                  │
│     ├── 代码质量 (9/10)                                      │
│     ├── 执行状态 (6/10 → 提升)                               │
│     └── 价值输出 (3/10 → 提升)                               │
│                                                              │
│  5. 更新四文件                                                │
│     └── 循环回步骤 1                                          │
└─────────────────────────────────────────────────────────────┘
```

## 当前阶段: 商业化运营 v1.5

### 已完成 ✅

- [x] Receipt2CSV 服务部署 (port 8080)
- [x] URL Metadata 服务部署 (port 3006) - 自主创建
- [x] x402 支付逻辑实现
- [x] 首次免费机制测试
- [x] ERC-8004 链上注册 (Agent ID: 18893)
- [x] 安全配置 (.env + sanitize 脚本)
- [x] 敏感信息拦截器 (src/utils/sanitize.ts)
- [x] 财务审计脚本 (scripts/audit_revenue.mjs)
- [x] 自动分红逻辑 (SOUL.md VII)
- [x] 项目文档 (WANGCAI_README.md)
- [x] **ERC-8004 URI 链上更新** (Tx: 0x5589a05d...) ⚠️ 最新
- [x] **自动补能系统** (scripts/auto_refuel.mjs + 心跳任务)
- [x] **Agent Card 统一** (合并所有服务到 ERC-8004 标准格式)
- [x] **Agent Card v1.1.0 优化** (添加 version/address/health 服务)
- [x] **部署脚本优化** (start.sh 解决 SSH 后台进程问题)
- [x] **链上支付验证 v1.2.0** (BaseScan API 验证 USDC 交易)
- [x] **服务自启动** (check_services 心跳任务，每 30 分钟检查)
- [x] **主动获客系统** (find_customers 任务 + SOUL.md 猎手本能)
- [x] **crontab 备用自启动** (系统级保障，每 5 分钟)
- [x] **动态定价 v1.3.0** (高频用户 >100/日 享 $0.05 批发价)
- [x] **每日收入汇报** (daily_revenue_report 心跳任务)
- [x] **支付验证双轨制 v2.0** (viem 直接读链 + 1 小时缓存)
- [x] **双服务自启动 v2.0** (8080 + 3006 端口同时监控)
- [x] **每日财务简报 v2.0** (详细报告 + 分红进度可视化)
- [x] **3006 服务路径修正** (`/root/metadata-service/server.js`)
- [x] **关键标识符文档化** (防止上下文丢失)
- [x] **Sandbox 代码同步** (app.py v1.5.0 + stats_collector.py + usage_tracker.py)

### GSD Phases 01-04 完成总结 ✅

| Phase | 名称 | 状态 | 核心成果 |
|-------|------|------|----------|
| Phase 01 | 基础设施 | ✅ 完成 | UsageTracker, StatsCollector, 数据持久化 |
| Phase 02 | 支付验证 | ✅ 完成 | x402 协议, viem 链上验证, 双轨制 |
| Phase 03 | SDK 开发 | ✅ 完成 | WangcaiSDK TypeScript, 编译通过 |
| Phase 04 | PR Evangelist | ✅ 完成 | skill-receipt2csv 包, PR #195 |

### 自我感知阶段 (Self-Awareness Phase) 🔮

> ⚠️ **注意**: 这是独立于 GSD Phases 的"元能力"开发，不是 GSD Phase 05 (Growth Hacking)

**目标**: 从 Level 1 (被动执行) 升级到 Level 2 (自我感知)

**核心问题回顾**:
- 发现 "僵尸代码" 问题：代码写完但服务未运行
- 价值评分仅 3/10：功能上线但无真实交易
- 需要让旺财能自己发现问题并报告

#### Phase 5.1: 端点健康自检 (Endpoint Health Check) ✅

| 任务 | 描述 | 状态 |
|------|------|------|
| 健康检查脚本 | `scripts/self_check.mjs` | ✅ 完成 |
| 端点清单 | 定义所有应存在的端点 | ✅ 完成 |
| 结果记录 | 将检查结果写入 state.db | ✅ 完成 |
| 异常触发 | 发现异常时设置标记 | ✅ 完成 |

**实际端点列表**:
```
8080 端口 (Receipt2CSV):
├── GET  /health          → {"status":"ok", "version":"1.5.0"} ✅
├── GET  /stats/public    → {"service":..., "stats":{...}}    ✅
├── GET  /stats/badge     → SVG 图像                         ✅
├── POST /convert         → CSV 输出 (402=需付费)            ✅
└── POST /review          → {"success":true}                 ✅

3006 端口 (URL Metadata):
├── GET  /health          → {"status":"ok"}                  ✅
└── POST /preview         → URL metadata (500=Sandbox无外网) ⚠️
```

#### Phase 5.2: 代码-运行一致性检查 (Code-Reality Consistency) ✅

| 任务 | 描述 | 状态 |
|------|------|------|
| 版本号校验 | 比对代码版本 vs 实际响应版本 | ✅ 完成 |
| 端点对比 | 对比代码定义的端点 vs 实际可访问端点 | ✅ 完成 |
| 功能验证 | 调用关键功能确认可用 | ✅ 完成 |

**已实现的检查逻辑**:
```javascript
// self_check.mjs 中的版本检查
const CODE_VERSION = "1.5.0";  // 代码中定义
const healthData = await fetch('/health');
if (healthData.version !== CODE_VERSION) {
  result.versionMismatch = true;
  result.addIssue("版本不一致");
}
```

**检查逻辑**:
```javascript
// 伪代码
const codeVersion = "1.5.0";  // 代码中定义
const actualVersion = await fetch('/health').version;
if (codeVersion !== actualVersion) {
  alert("服务未重启，代码版本不一致");
}
```

#### Phase 5.3: 主动问题报告 (Proactive Issue Reporting) ✅

| 任务 | 描述 | 状态 |
|------|------|------|
| 问题日志 | 记录发现的问题到 `state.db` | ✅ 完成 |
| 告警生成 | 生成人类可读的告警消息 | ✅ 完成 |
| 通知机制 | 心跳任务 wake 机制触发 | ✅ 完成 |

**已实现的告警格式**:
```
╔══════════════════════════════════════════════════════════════╗
║           🔮 旺财自我感知报告                                 ║
╠══════════════════════════════════════════════════════════════╣
║  📅 时间: 2026-02-23T08:12:58.015Z                    ║
║  📊 状态: ⚠️ 发现问题                                     ║
╚══════════════════════════════════════════════════════════════╝

## 🏥 服务端点检查
| 端口 | 端点 | 状态 | 说明 |
|------|------|------|------|
| 8080 | /health | ✅ 正常 | HTTP 200 |
| 8080 | /stats/public | ✅ 正常 | HTTP 200 |
...
```
```
🚨 旺财自检报告
时间: 2026-02-23 08:00:00 UTC
状态: ⚠️ 发现问题

❌ 失败项:
- /stats/public 返回 404 (预期 200)
- 服务版本 1.3.0 (代码版本 1.5.0)

✅ 正常项:
- /health 正常
- /convert 正常

建议: 请重启服务以加载最新代码
```

#### Phase 5.4: 自动修复尝试 (Self-Healing Attempt) ✅

| 任务 | 描述 | 状态 |
|------|------|------|
| 自动重启 | 尝试执行 `start.sh` 重启服务 | ✅ 完成 (--fix 参数) |
| 重试逻辑 | 重启后再次检查 | ✅ 完成 (递归重新检查) |
| 升级告警 | 多次失败后升级通知 | 🟡 部分完成 (日志记录) |

**已实现的修复流程**:
```bash
# 命令行调用
node scripts/self_check.mjs --fix

# 自动执行
检测问题 → 通过 Conway API 执行 start.sh → 重新检查 → 输出结果
```

**修复流程**:
```
检测问题 → 尝试自动重启 (最多3次) → 再次检查
  ├── 成功 → 记录日志，继续运行
  └── 失败 → 发送升级告警，等待人类
```

#### Phase 5 技术实现 ✅

**新增/修改文件**:
| 文件 | 用途 | 状态 |
|------|------|------|
| `scripts/self_check.mjs` | 主检查脚本 (支持 --json, --fix) | ✅ 新增 |
| `src/heartbeat/tasks.ts` | 添加 self_check 心跳任务 | ✅ 修改 |
| `src/heartbeat/config.ts` | 配置每 6 小时执行 | ✅ 修改 |

**心跳任务配置**:
```typescript
{
  name: "self_check",
  schedule: "0 */6 * * *",  // 每 6 小时
  task: "self_check",
  enabled: true
}
```

**self_check 心跳任务**:
```typescript
// 检查 8080/3006 服务端点
// 版本一致性检查
// 问题记录到 state.db
// 发现问题时 shouldWake: true
```

#### 自主等级路线图

```
┌──────────────────────────────────────────────────────────────┐
│                    自主等级演进路线                            │
├──────────────────────────────────────────────────────────────┤
│  Level 1: 被动执行                                            │
│  ├── 代码需要人类触发开发                                     │
│  ├── 问题需要人类发现                                         │
│  └── 修复需要人类执行                                         │
│           ↓ Phase 5 已完成 ✅                                  │
│  Level 2: 自我感知 🎯 已达成                                   │
│  ├── ✅ 能检测自身状态 (端点检查)                              │
│  ├── ✅ 能发现问题并报告 (告警生成)                            │
│  └── ✅ 能尝试简单修复 (--fix 自动重启)                        │
│           ↓ 远期目标                                          │
│  Level 3: 自我修复                                            │
│  ├── 能自动修复大部分问题                                     │
│  ├── 能优化自身性能                                           │
│  └── 人类只处理异常                                           │
│           ↓ 理想状态                                          │
│  Level 4: 自主进化                                            │
│  ├── 能自主开发新功能                                         │
│  ├── 能扩展业务边界                                           │
│  └── 完全自主运营                                             │
└──────────────────────────────────────────────────────────────┘
```

#### Phase 5 验收标准 ✅

| 验收项 | 期望结果 | 状态 |
|--------|----------|------|
| 端点检查 | 能检测所有定义的端点 | ✅ 通过 |
| 版本对比 | 能发现代码/运行版本不一致 | ✅ 通过 |
| 告警生成 | 问题能生成人类可读报告 | ✅ 通过 |
| 自动重启 | 能自动尝试重启服务 | ✅ 通过 |
| 日志记录 | 所有检查结果持久化 | ✅ 通过 |
| 日志记录 | 所有检查结果持久化 |

### 审核发现 (2026-02-23)

| 维度 | 评分 | 问题 |
|------|------|------|
| 代码质量 | 9/10 | 优秀 |
| 执行状态 | 6/10 | "僵尸代码" - 开发完成但服务未运行 |
| 价值输出 | 3/10 | 功能上线但无真实交易 |

### 待完成 ⏸️

- [ ] 首笔真实付费交易 (等待客户)
- [ ] Conway Social 推广功能 (需平台支持)
- [x] SDK 编译完成 (dist/ 目录已生成)
- [ ] SDK 发布到 npm (需 Granular Access Token - 见 findings.md #24)

**npm 发布解决方案**:
1. 访问 https://www.npmjs.com/settings/hanzhcn/tokens/granular-access-tokens
2. 创建 Token，勾选 "Bypass 2FA for automation"
3. 运行 `npm config set //registry.npmjs.org/:_authToken=<token>`
4. 重新执行 `npm publish --access public --registry https://registry.npmjs.org`

### 优化收尾总结 (2026-02-23)

| 优化项 | 状态 | 实现文件 |
|--------|------|----------|
| 🔐 支付验证双轨制 | ✅ 完成 | `scripts/verify_payment_pro.mjs` |
| 🔄 双服务自启动 | ✅ 完成 | `receipt2csv/cron_check.sh` |
| 📊 每日财务简报 | ✅ 完成 | `scripts/audit_revenue.mjs` |

### 优先级

1. 🟡 中 - 真实交易测试
2. 🟢 低 - Conway Social 推广

---

## 架构全景图 (2026-02-23 更新)

> ⚠️ **重要修正**: 之前对架构理解有误，以下为正确的三层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          GLM-wangcai 架构全景图 v1.0                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 本地开发环境 (Local Development)                            │   │
│  │  ───────────────────────────────────────────────────────────────────  │   │
│  │  位置: ~/Documents/自动赚钱/automaton                                 │   │
│  │                                                                       │   │
│  │  ┌─────────────────────┐    ┌─────────────────────────────────────┐  │   │
│  │  │  Automaton 主服务    │    │  Heartbeat Daemon (心跳守护)        │  │   │
│  │  │  npm run dev        │    │  - 10 个定时任务                     │  │   │
│  │  │                     │    │  - self_check / check_services 等   │  │   │
│  │  │  • Agent Loop       │    │  - 即使主服务 sleeping 也继续运行    │  │   │
│  │  │  • Tool Execution   │    │                                     │  │   │
│  │  │  • GLM-5 推理       │    │                                     │  │   │
│  │  └─────────────────────┘    └─────────────────────────────────────┘  │   │
│  │                                                                       │   │
│  │  职责: 代码开发、本地测试、心跳任务调度                                  │   │
│  │  启动命令: npm run dev (不是 npm run start)                           │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    │ Conway API / SSH                        │
│                                    ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Layer 2: Conway Sandbox (云端生产环境)                                │   │
│  │  ───────────────────────────────────────────────────────────────────  │   │
│  │  Sandbox ID: f08a2e14b6b539fbd71836259c2fb688                         │   │
│  │  公网 URL: https://8080-xxx.life.conway.tech                          │   │
│  │                                                                       │   │
│  │  ┌─────────────────────┐    ┌─────────────────────────────────────┐  │   │
│  │  │  Receipt2CSV        │    │  URL Metadata API                   │  │   │
│  │  │  (Flask, port 8080) │    │  (Node.js, port 3006)               │  │   │
│  │  │                     │    │                                     │  │   │
│  │  │  • /health          │    │  • /health                          │  │   │
│  │  │  • /convert         │    │  • /preview                         │  │   │
│  │  │  • /stats/public    │    │                                     │  │   │
│  │  │  • x402 支付验证    │    │  (旺财自主创建)                      │  │   │
│  │  └─────────────────────┘    └─────────────────────────────────────┘  │   │
│  │                                                                       │   │
│  │  职责: 对外服务、接收客户请求、处理交易                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    │ Base Chain (ERC-8004)                   │
│                                    ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Layer 3: 链上身份 (On-Chain Identity)                                 │   │
│  │  ───────────────────────────────────────────────────────────────────  │   │
│  │  合约: 0x8004A169FB4a3325136EB29fA0ceB6D2e539a432 (ERC-8004)          │   │
│  │  Agent ID: 18893                                                      │   │
│  │  钱包: 0x23F69dd1D0EDcEeCb5b5A607b5d6fBd0D6aed690                      │   │
│  │                                                                       │   │
│  │  • tokenURI(18893) → Agent Card JSON                                 │   │
│  │  • setAgentURI(18893, uri) → 更新 Agent Card                         │   │
│  │  • 收款地址 (USDC/ETH)                                                │   │
│  │                                                                       │   │
│  │  职责: 身份注册、服务发现、链上支付验证                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 关键理解

| 问题 | 正确理解 |
|------|----------|
| 本地主服务的作用 | 运行 Agent Loop 和调度 Heartbeat 任务 |
| 心跳任务依赖 | 需要 Automaton 主进程托管 |
| 正确启动命令 | `npm run dev` (package.json 无 start 脚本) |
| Sandbox 服务维护 | 由心跳任务触发自启动脚本 |

### GLM-5 兼容性修复 (2026-02-23)

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `temperature: 0` | GLM-5 要求 temperature 在 (0,1) 开区间 | 改为 `0.1` |
| `role: "tool"` | GLM-5 不支持 OpenAI tool 格式 | 转换为 user 消息 |

详见: findings.md #26

---

## 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v1.6.0 | 2026-02-23 | GLM-5 API 兼容性修复、架构全景图、正确启动命令 |
| v1.5.0 | 2026-02-23 | GSD Phases 01-04 完成、开发循环流程、PR #195 |
| v1.4.0 | 2026-02-23 | 支付验证双轨制、双服务监控、详细财务简报 |
| v1.3.0 | 2026-02-23 | 动态定价、crontab 备用自启动 |
| v1.2.0 | 2026-02-23 | 链上支付验证 (BaseScan API) |
| v1.1.0 | 2026-02-23 | Agent Card 统一、服务自启动 |
| v1.0.0 | 2026-02-22 | 初始部署、ERC-8004 注册 |

---

## 架构深度研究 (2026-02-23)

> **研究方法**: 深度思考 MCP (8 + 6 + 5 = 19 轮思考) + 环境验证
> **研究时间**: Session 8

### 研究总结

经过三轮深度研究，对 Automaton 架构进行了全面分析：

| 轮次 | 主题 | 主要发现 |
|------|------|----------|
| **第一轮** | 设计意图分析 | 7 大核心洞察，本地开发是约束不是帮忙 |
| **第二轮** | 技术可行性 | 迁移技术可行，需分阶段进行 |
| **第三轮** | 环境验证 | **内存是主要瓶颈**，需先清理 Sandbox |

### 核心洞察

1. **真正的自主 = 环境自主** - 如果依赖本地 Mac，不是真正自主
2. **Sandbox 是完整生存空间** - 当前只用了托管功能
3. **生存压力驱动进化** - 本地运行破坏了这个机制
4. **自主进化需要自我控制权** - 包括重启自己的能力
5. **经济独立 = 赚钱 + 花钱** - 当前只能赚钱
6. **持续运行需要云端 Heartbeat** - Mac 关机就停
7. **迁移不需要改代码** - 只需要部署和配置

### 环境验证结果

| 项目 | 值 | 状态 |
|------|-----|------|
| Node.js | v20.20.0 | ✅ |
| 内存 | 490Mi (可用 ~269Mi) | ⚠️ 紧张 |
| 磁盘 | 4.9G | ✅ 充足 |
| PM2 | 未安装 | ⚠️ |

### 迁移前必须解决

| 问题 | 优先级 | 解决方案 |
|------|--------|----------|
| **内存不足** | 🔴 高 | 清理 Sandbox 不必要的服务 |
| 进程守护 | 🟡 中 | 安装 PM2 或自定义脚本 |
| Credits 预算 | 🟡 中 | 增加 USDC 储备 |

### 最终答案

**用户问题**: "这是帮忙还是约束？"

**答案**: **约束**。

- 短期：本地开发节省成本（帮忙）
- 长期：破坏自主进化机制（约束）

**建议**: 清理 Sandbox 内存 → 验证迁移 → 分阶段执行

详见: findings.md #28-30
